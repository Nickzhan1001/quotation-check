# 功能規格：報價單擷取與 JSON 檢視

**功能分支**：`[001-quotation-check]`  
**建立日期**：2026-02-05  
**狀態**：草稿  
**輸入**：使用者描述：「根據現有功能，補 spec-kit 規格」

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - DOCX 擷取成 JSON（優先級：P1）

使用者將 .docx 報價單放入指定資料夾，透過 CLI 指令將內容擷取為 JSON，供後續檢視與比對。

**為何是此優先級**：這是整個流程的資料來源，沒有擷取就無法檢視與後續作業。

**獨立測試**：使用範例 .docx 執行 `npm run extract-docx`，確認輸出 JSON 結構與欄位完整。

**驗收情境**：

1. **假設** `quote-analysis/input` 有有效 .docx，**當** 執行 `npm run extract-docx`，**則** 產生 JSON 且包含 `source`、`extractedAt`、`paragraphs`、`titles`、`tables`、`tablesAsObjects`。
2. **假設** 表格中缺少「報價」欄位，**當** 擷取完成，**則** `tables` 表頭補上「報價」，對應資料列值為空字串。
3. **假設** 表格內因分頁續表重複表頭列，**當** 擷取完成，**則** `tables` 僅保留第一列表頭，不重複輸出表頭列。

---

### 使用者故事 2 - JSON 檢視與表格呈現（優先級：P2）

使用者在瀏覽器載入 JSON，依章節與表格還原內容，快速檢視段落與功能列表表格。

**為何是此優先級**：讓擷取後資料可立即被人員檢視，提升可讀性與溝通效率。

**獨立測試**：開啟 Viewer 載入 JSON，確認章節位於對應表格上方，且表格不顯示「報價」欄位。

**驗收情境**：

1. **假設** 有有效 JSON，**當** 使用「開啟(可寫入)」或拖放載入，**則** 章節、段落、表格皆可呈現。
2. **假設** 表格包含「報價」欄位，**當** Viewer 顯示表格，**則** UI 隱藏「報價」欄位但 JSON 仍保留。
3. **假設** 表格資料列很多，**當** 首次載入，**則** 預設只顯示前 60 列，可逐步展開或全部展開。

---

### 使用者故事 3 - 表格編輯並回寫 JSON 檔案（優先級：P3）

使用者在 Viewer 直接編輯表格欄位，完成編輯後回寫到原始 JSON 檔案。

**為何是此優先級**：方便人工微調或補填欄位，不必手動編輯 JSON。

**獨立測試**：在 Viewer 編輯表格欄位並儲存，重新載入同一檔案時修改內容仍存在。

**驗收情境**：

1. **假設** 使用「開啟(可寫入)」載入 JSON，**當** 進入編輯模式修改表格並按「完成編輯」，**則** 內容同步回寫至 JSON 檔。
2. **假設** 無可寫入檔案 handle，**當** 按「儲存 JSON」，**則** 以檔案選擇器或下載方式輸出 JSON。

---

### 邊界情境（Edge Cases）

- 載入非 JSON 或格式錯誤的檔案時，應顯示錯誤訊息且不更新畫面。
- 瀏覽器不支援 File System Access API 時，應提供提示並允許改用下載方式。
- 表格為空或欄位不足時，仍需產生可用的表頭與空值。
- `.docx` 路徑不存在時，CLI 應回報錯誤並結束。

## 需求 *(必填)*

### 功能性需求

- **FR-001**：系統 MUST 解析 `.docx` 的 `word/document.xml` 並擷取段落與表格。
- **FR-002**：系統 MUST 依文字規則分類段落類型（`title` / `date` / `note` / `heading` / `content` / `empty`）。
- **FR-003**：系統 MUST 移除表格內重複表頭列（分頁續表）。
- **FR-004**：系統 MUST 在表格缺少「報價」欄位時補上該欄位並填空值。
- **FR-005**：系統 MUST 將空白表頭第 4 欄命名為「操作說明」，第 5 欄命名為「報價」。
- **FR-006**：系統 MUST 輸出 `source`、`extractedAt`、`paragraphs`、`titles`、`tables`、`tablesAsObjects`。
- **FR-007**：Viewer MUST 支援 JSON 載入（開啟可寫入、拖放）。
- **FR-008**：Viewer MUST 在每張表格上方顯示對應章節，且 UI 隱藏「報價」欄位。
- **FR-009**：Viewer MUST 提供表格編輯模式，可修改表頭與資料列。
- **FR-010**：Viewer MUST 可將編輯結果回寫 JSON 檔案或匯出新檔。
- **FR-011**：Viewer MUST 預設只顯示表格前 60 列，支援逐步展開與全部展開。
- **FR-012**：列印時 MUST 自動展開所有表格列，避免缺列。

### 主要資料實體 *(若功能涉及資料，請填)*

- **Document**：一次擷取的報價單，包含來源檔名、擷取時間、段落、章節、表格。
- **Paragraph**：文本段落，包含 `text` 與 `type`。
- **Table**：由列與欄組成的二維資料，第一列為表頭。

## 成功標準 *(必填)*

### 可衡量成果

- **SC-001**：以預設 `.docx` 執行擷取後，輸出的 JSON 具備必備欄位且可被 Viewer 載入。
- **SC-002**：Viewer 載入包含 3 張表格、每張 100+ 列的 JSON 時，畫面可於 3 秒內可操作。
- **SC-003**：修改任一表格欄位後按「完成編輯」並儲存，重新載入檔案可看到修改內容。
- **SC-004**：表格 UI 不顯示「報價」欄位，但 JSON 仍保留該欄位。
