# 功能規格：既有系統行為參考文件

**功能分支**：`002-quotation-viewer-docs`  
**建立日期**：2026-02-06  
**狀態**：草稿  
**輸入**：整理現有專案已實現的功能與行為，供後續行為索引用途

## 系統概覽

本系統包含兩大功能區塊：
1. **CLI 擷取工具**：將 `.docx` 報價單解析為結構化 JSON
2. **Web 檢視器**：在瀏覽器中載入、檢視、編輯 JSON 內容

---

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - DOCX 轉 JSON（CLI）

使用者透過指令列執行擷取程式，將 Word 報價單轉換為 JSON 格式。

**執行方式**：
- `npm run extract-docx` - 使用預設路徑
- `node scripts/extract-docx-to-json.mjs <input.docx>` - 指定輸入檔
- `node scripts/extract-docx-to-json.mjs <input.docx> -o <output.json>` - 指定輸出檔

**預設路徑**：
- 輸入：`quote-analysis/input/` 內最新修改的 `.docx`
- 輸出：`quote-analysis/output/` 下的同名 `.json` 檔

**驗收情境**：

1. **假設** 執行時無提供參數，**當** `quote-analysis/input/` 有 `.docx` 檔案，**則** 自動選取最新修改的檔案進行擷取。
2. **假設** 執行時提供 `-o` 參數並指定輸出路徑，**當** 路徑為中文，**則** 在 Windows PowerShell 可能發生編碼錯誤（已知限制）。
3. **假設** 輸入檔案不是 `.docx` 格式，**當** 執行擷取，**則** 顯示錯誤訊息 `錯誤：輸入檔案必須是 .docx 格式` 並以 exit code 1 結束。
4. **假設** 輸入檔案不存在，**當** 執行擷取，**則** 顯示錯誤訊息 `錯誤：找不到檔案` 並以 exit code 1 結束。
5. **假設** 成功完成擷取，**當** 輸出至主控台，**則** 顯示 `已完成，輸出至：<路徑>` 以及段落與表格數量統計。

---

### 使用者故事 2 - JSON 載入（Viewer）

使用者在瀏覽器中載入 JSON 檔案以檢視報價單內容。

**載入方式**：
- 點擊「開啟檔案」按鈕，使用系統檔案選擇器
- 將 `.json` 檔案拖放至頁面
- 在文字區塊貼上 JSON 內容並點擊「載入」

**驗收情境**：

1. **假設** 使用者點擊「開啟檔案」按鈕，**當** 選擇 `.json` 檔案，**則** 檔案內容被解析並顯示文件資訊與內容。
2. **假設** 使用者拖放非 `.json` 檔案至頁面，**當** 放開滑鼠，**則** 顯示錯誤訊息 `請選擇 .json 檔案`。
3. **假設** 使用者貼上格式錯誤的 JSON 文字，**當** 點擊「載入」，**則** 顯示解析錯誤訊息。
4. **假設** 瀏覽器不支援 File System Access API（`showOpenFilePicker`），**當** 點擊「開啟檔案」，**則** 顯示提示訊息 `目前瀏覽器不支援可寫入檔案存取（建議使用 Chrome/Edge）`。
5. **假設** 成功載入 JSON，**當** 頁面渲染完成，**則** 左側面板顯示文件資訊（來源、擷取時間、標題猜測），右側面板顯示段落與表格內容。

---

### 使用者故事 3 - 文件檢視（Viewer）

使用者檢視載入的報價單內容，包含段落分類與表格呈現。

**顯示項目**：
- 段落列表（依類型分類顯示）
- 章節標題與對應表格
- 表格預設顯示前 60 列

**驗收情境**：

1. **假設** 載入包含段落的 JSON，**當** 渲染完成，**則** 段落依照 `type` 顯示對應標籤（標題、日期、備註、章節、內文、空白）。
2. **假設** 表格上方有對應章節標題，**當** 渲染完成，**則** 標題顯示於表格上方。
3. **假設** 表格資料超過 60 列，**當** 初次載入，**則** 只顯示前 60 列，底部顯示 `目前顯示 60 / <總列數>` 以及操作按鈕。
4. **假設** 表格包含「報價」欄位，**當** 渲染完成，**則** UI 隱藏該欄位但 JSON 仍保留。
5. **假設** 使用者點擊「顯示更多」按鈕，**當** 完成操作，**則** 再載入 120 列（上限 10,000 列）。
6. **假設** 使用者點擊「全部展開」按鈕，**當** 完成操作，**則** 顯示表格所有列。
7. **假設** 使用者點擊「收合」按鈕，**當** 完成操作，**則** 表格恢復顯示前 60 列。

---

### 使用者故事 4 - 表格編輯（Viewer）

使用者在檢視器中直接編輯表格內容。

**操作方式**：
- 點擊「編輯表格」按鈕進入編輯模式
- 在表格輸入框中修改欄位值
- 點擊「完成編輯」退出編輯模式

**驗收情境**：

1. **假設** 使用者尚未載入文件，**當** 點擊「編輯表格」按鈕，**則** 按鈕為禁用狀態。
2. **假設** 使用者點擊「編輯表格」按鈕，**當** 進入編輯模式，**則** 所有表格欄位變為可輸入的文字框，按鈕文字改為「完成編輯」。
3. **假設** 使用者在編輯模式修改表格欄位，**當** 點擊「完成編輯」，**則** 修改內容同步至記憶體中的 JSON。
4. **假設** 使用者退出編輯模式，**當** 未執行儲存，**則** 原始檔案內容不變。

---

### 使用者故事 5 - JSON 儲存（Viewer）

使用者將編輯後的 JSON 儲存回檔案或下載新檔案。

**儲存方式**：
- 以可寫入方式開啟檔案（支援 File System Access API）
- 使用「儲存 JSON」按鈕寫入
- 若不支援 API，則以下載方式輸出

**驗收情境**：

1. **假設** 使用者以可寫入方式開啟檔案，**當** 完成編輯並點擊「儲存 JSON」，**則** 內容寫入原始檔案。
2. **假設** 無可寫入 handle（拖放或貼上載入），**當** 點擊「儲存 JSON」，**則** 開啟系統儲存對話框或以下載方式輸出。
3. **假設** 下載方式輸出，**當** 完成操作，**則** 產生 `quotation.json` 檔案並觸發下載。
4. **假設** 檔名未知，**則** 使用 `doc.value?.source` 或預設 `quotation.json` 作為下載檔名。

---

### 使用者故事 6 - 清除資料（Viewer）

使用者清除目前載入的資料，重新載入新檔案。

**操作方式**：
- 點擊「清除」按鈕

**驗收情境**：

1. **假設** 使用者已載入 JSON 或正在編輯，**當** 點擊「清除」按鈕，**則** 清空所有資料與編輯狀態，畫面恢復為空白狀態。
2. **假設** 無資料載入，**當** 點擊「清除」按鈕，**則** 按鈕為禁用狀態。

---

### 使用者故事 7 - 列印功能（Viewer）

使用者將報價單內容列印或儲存為 PDF。

**操作方式**：
- 點擊「列印」按鈕

**驗收情境**：

1. **假設** 使用者已載入文件，**當** 點擊「列印」按鈕，**則** 瀏覽器開啟列印對話框。
2. **假設** 執行列印，**當** 對話框開啟，**則** 所有表格自動展開至全部列數。
3. **假設** 列印完成或取消，**當** 返回頁面，**則** 表格恢復原本的顯示列數限制。

---

## 需求 *(必填)*

### 功能性需求

#### CLI 擷取工具

- **FR-CLI-001**：系統 MUST 解析 `.docx` 的 `word/document.xml` 內容。
- **FR-CLI-002**：系統 MUST 支援預設路徑模式（不帶參數執行）。
- **FR-CLI-003**：系統 MUST 支援指定輸入檔案路徑。
- **FR-CLI-004**：系統 MUST 支援指定輸出檔案路徑（`-o` 或 `--output`）。
- **FR-CLI-005**：系統 MUST 依規則分類段落類型（`title` / `date` / `note` / `heading` / `content` / `empty`）。
- **FR-CLI-006**：段落分類規則：
  - `title`：符合 `報 價 單` 或 `報價 單` 格式
  - `date`：包含日期格式（`YYYY.MM.DD`、 `YYYY/MM/DD` 或 `日期：...`）
  - `note`：以 `※` 或 `★` 開頭
  - `heading`：包含 `功能列表` 或 `作業列表`
  - `empty`：空字串或僅空白
  - `content`：其他非空文字
- **FR-CLI-007**：系統 MUST 移除表格中重複出現的表頭列（常見於分頁續表）。
- **FR-CLI-008**：系統 MUST 確保表格包含「編號」欄位，若缺少則補上。
- **FR-CLI-009**：系統 MUST 確保表格包含「報價」欄位，若缺少則補上。
- **FR-CLI-010**：系統 MUST 將表頭名稱正規化為英文（`編號` → `ID`、`主功能` → `Feature` 等）。
- **FR-CLI-011**：系統 MUST 輸出 JSON 結構包含 `source`、`extractedAt`、`paragraphs`、`titles`、`tables`、`tablesAsObjects`。
- **FR-CLI-012**：系統 MUST 在缺少 `ID` 且所有資料列 ID 皆為空時，自動填入流水號（1 起）。
- **FR-CLI-013**：系統 MUST 清除 OOXML 雜訊（字型名稱、樣式十六進位碼）。

#### Viewer 介面

- **FR-VIEW-001**：系統 MUST 支援三種 JSON 載入方式：開啟檔案、拖放、貼上。
- **FR-VIEW-002**：系統 MUST 驗證輸入為 `.json` 副檔名。
- **FR-VIEW-003**：系統 MUST 解析 JSON 並顯示文件資訊（來源、擷取時間、標題）。
- **FR-VIEW-004**：系統 MUST 顯示段落列表，並以標籤標示類型。
- **FR-VIEW-005**：系統 MUST 在表格上方顯示對應章節標題。
- **FR-VIEW-006**：系統 MUST 預設隱藏「報價」欄位（UI 不顯示，JSON 保留）。
- **FR-VIEW-007**：系統 MUST 預設只顯示表格前 60 列。
- **FR-VIEW-008**：系統 MUST 支援「顯示更多」（+120 列）與「全部展開」功能。
- **FR-VIEW-009**：系統 MUST 支援編輯模式，切換表格欄位為可輸入框。
- **FR-VIEW-010**：系統 MUST 支援三種儲存方式：
  - 寫入原始檔案（若使用 File System Access API 開啟）
  - 儲存新檔案（系統儲存對話框）
  - 下載檔案（fallback）
- **FR-VIEW-011**：系統 MUST 支援「清除」功能重置狀態。
- **FR-VIEW-012**：系統 MUST 支援「列印」功能，列印時自動展開所有表格。
- **FR-VIEW-013**：系統 MUST 處理 File System Access API 不支援的瀏覽器，提供替代下載方式。
- **FR-VIEW-014**：系統 MUST 提供錯誤訊息顯示（JSON 解析失敗、檔案類型錯誤等）。
- **FR-VIEW-015**：系統 MUST 在編輯模式下，按鈕與輸入框狀態正確响应。

### 主要資料實體

- **Document**：完整 JSON 文件結構
  - `source`：來源檔名
  - `extractedAt`：ISO 格式擷取時間
  - `paragraphs`：段落陣列，每筆包含 `text` 與 `type`
  - `titles`：章節標題陣列
  - `tables`：二維表格陣列（第一列為表頭）
  - `tablesAsObjects`：物件化表格陣列

- **Paragraph**：段落物件
  - `text`：段落文字內容
  - `type`：段落類型（`title` / `date` / `note` / `heading` / `content` / `empty`）

- **Table**：表格資料
  - 列陣列結構，第一列為表頭
  - 欄位經過正規化處理

---

## 成功標準 *(必填)*

### 可衡量成果

- **SC-001**：CLI 指令可在 5 秒內完成 100 頁以內報價單的擷取。
- **SC-002**：Viewer 可於 3 秒內載入並渲染包含 3 張表格、每張 100 列資料的 JSON。
- **SC-003**：所有使用者操作（開啟、編輯、儲存、列印）皆有明確的視覺回饋。
- **SC-004**：錯誤情境（格式錯誤、檔案不存在、API 不支援）皆有繁體中文錯誤訊息。
- **SC-005**：表格編輯與儲存功能可正確執行，修改後重新載入可見更新內容。

---

## 行為差異參照

| 行為項目 | CLI 行為 | Viewer 行為 |
|---------|---------|-----------|
| 段落分類 | 自動分類（6 類） | 僅顯示，不重新分類 |
| 表格欄位處理 | 補齊 ID、報價欄位 | 直接呈現 |
| 表格展開 | 不適用 | 預設 60 列，可展開 |
| 編輯功能 | 不適用 | 支援表格欄位編輯 |
| 儲存方式 | 輸出至檔案 | 寫入、下載、儲存對話框 |
| 列印 | 不適用 | 自動展開所有列 |

---

## 已知限制

1. **Windows PowerShell 中文路徑**：CLI 使用 `-o` 參數搭配中文路徑時可能發生編碼錯誤。
2. **瀏覽器相容性**：File System Access API 僅支援 Chrome/Edge，其他瀏覽器使用下載方式。
3. **JSON 檔案驗證**：Viewer 只驗證副檔名為 `.json`，不驗證內容結構（解析失敗時顯示錯誤）。
4. **表格寬度對齊**：CLI 確保同表格所有列寬度一致，不同表格間寬度可能不同。
5. **單一文件支援**：系統目前僅支援一次處理一份報價單。
